<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Database Communication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Frontend Database Communication Test</h1>
        <p>This page tests the frontend's ability to communicate with the backend database APIs.</p>
        
        <div class="test-section">
            <h3>1. Backend Service Health Check</h3>
            <button onclick="testBackendHealth()">Test Backend Health</button>
            <div id="healthResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. User Analyses API Test</h3>
            <button onclick="testUserAnalyses()">Test User Analyses API</button>
            <div id="userAnalysesResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Analysis by ID API Test</h3>
            <button onclick="testAnalysisById()">Test Analysis by ID API</button>
            <div id="analysisByIdResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Analysis Summary API Test</h3>
            <button onclick="testAnalysisSummary()">Test Analysis Summary API</button>
            <div id="analysisSummaryResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. Filtered Analyses API Tests</h3>
            <button onclick="testFilteredAnalyses()">Test Filtered Analyses APIs</button>
            <div id="filteredAnalysesResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>6. Complete Frontend-Backend Flow Test</h3>
            <button onclick="testCompleteFlow()">Test Complete Flow</button>
            <div id="completeFlowResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Test Summary</h3>
            <div id="testSummary" class="result info"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8001';
        let testResults = {};

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        function showLoading(elementId) {
            showResult(elementId, '‚è≥ Testing...', 'loading');
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function testBackendHealth() {
            showLoading('healthResult');
            
            const result = await makeRequest(`${BACKEND_URL}/health`);
            
            if (result.success) {
                showResult('healthResult', 
                    `‚úÖ Backend Health Check PASSED\n` +
                    `Status: ${result.data.status}\n` +
                    `Service: ${result.data.service}\n` +
                    `Timestamp: ${result.data.timestamp}\n` +
                    `Components: ${JSON.stringify(result.data.components, null, 2)}`, 
                    'success'
                );
                testResults.health = true;
            } else {
                showResult('healthResult', 
                    `‚ùå Backend Health Check FAILED\n` +
                    `Error: ${result.error || 'Unknown error'}\n` +
                    `Status: ${result.status || 'N/A'}`, 
                    'error'
                );
                testResults.health = false;
            }
            updateTestSummary();
        }

        async function testUserAnalyses() {
            showLoading('userAnalysesResult');
            
            // First, we need to get a user ID from the database
            // For testing, we'll use a hardcoded user ID that we know exists
            const testUserId = '6036aee5-624c-4275-8482-f77d32723c32';
            
            const result = await makeRequest(`${BACKEND_URL}/analyses/user/${testUserId}?limit=5`);
            
            if (result.success) {
                const analyses = result.data.analyses || [];
                showResult('userAnalysesResult', 
                    `‚úÖ User Analyses API PASSED\n` +
                    `User ID: ${testUserId}\n` +
                    `Analyses Count: ${result.data.count}\n` +
                    `First Analysis: ${analyses.length > 0 ? 
                        `ID: ${analyses[0].id}, Stock: ${analyses[0].stock_symbol}, Signal: ${analyses[0].overall_signal}` : 
                        'No analyses found'}\n` +
                    `Response: ${JSON.stringify(result.data, null, 2)}`, 
                    'success'
                );
                testResults.userAnalyses = true;
            } else {
                showResult('userAnalysesResult', 
                    `‚ùå User Analyses API FAILED\n` +
                    `Error: ${result.error || 'Unknown error'}\n` +
                    `Status: ${result.status || 'N/A'}`, 
                    'error'
                );
                testResults.userAnalyses = false;
            }
            updateTestSummary();
        }

        async function testAnalysisById() {
            showLoading('analysisByIdResult');
            
            // First get a user's analyses to get an analysis ID
            const testUserId = '6036aee5-624c-4275-8482-f77d32723c32';
            const userResult = await makeRequest(`${BACKEND_URL}/analyses/user/${testUserId}?limit=1`);
            
            if (!userResult.success || !userResult.data.analyses || userResult.data.analyses.length === 0) {
                showResult('analysisByIdResult', 
                    `‚ùå Analysis by ID API FAILED\n` +
                    `No analyses found for user ${testUserId}`, 
                    'error'
                );
                testResults.analysisById = false;
                updateTestSummary();
                return;
            }
            
            const analysisId = userResult.data.analyses[0].id;
            const result = await makeRequest(`${BACKEND_URL}/analyses/${analysisId}`);
            
            if (result.success) {
                const analysis = result.data.analysis;
                showResult('analysisByIdResult', 
                    `‚úÖ Analysis by ID API PASSED\n` +
                    `Analysis ID: ${analysisId}\n` +
                    `Stock: ${analysis.stock_symbol}\n` +
                    `Signal: ${analysis.overall_signal}\n` +
                    `Confidence: ${analysis.confidence_score}\n` +
                    `Analysis Data Present: ${analysis.analysis_data_json ? 'Yes' : 'No'}\n` +
                    `Response: ${JSON.stringify(result.data, null, 2)}`, 
                    'success'
                );
                testResults.analysisById = true;
            } else {
                showResult('analysisByIdResult', 
                    `‚ùå Analysis by ID API FAILED\n` +
                    `Error: ${result.error || 'Unknown error'}\n` +
                    `Status: ${result.status || 'N/A'}`, 
                    'error'
                );
                testResults.analysisById = false;
            }
            updateTestSummary();
        }

        async function testAnalysisSummary() {
            showLoading('analysisSummaryResult');
            
            const testUserId = '6036aee5-624c-4275-8482-f77d32723c32';
            const result = await makeRequest(`${BACKEND_URL}/analyses/summary/user/${testUserId}`);
            
            if (result.success) {
                const summary = result.data.summary;
                showResult('analysisSummaryResult', 
                    `‚úÖ Analysis Summary API PASSED\n` +
                    `User ID: ${testUserId}\n` +
                    `Total Analyses: ${summary.total_analyses}\n` +
                    `Unique Stocks: ${summary.unique_stocks}\n` +
                    `Average Confidence: ${summary.avg_confidence}\n` +
                    `Signal Distribution: ${JSON.stringify(summary.signal_distribution)}\n` +
                    `Sector Distribution: ${JSON.stringify(summary.sector_distribution)}\n` +
                    `Response: ${JSON.stringify(result.data, null, 2)}`, 
                    'success'
                );
                testResults.analysisSummary = true;
            } else {
                showResult('analysisSummaryResult', 
                    `‚ùå Analysis Summary API FAILED\n` +
                    `Error: ${result.error || 'Unknown error'}\n` +
                    `Status: ${result.status || 'N/A'}`, 
                    'error'
                );
                testResults.analysisSummary = false;
            }
            updateTestSummary();
        }

        async function testFilteredAnalyses() {
            showLoading('filteredAnalysesResult');
            
            const testUserId = '6036aee5-624c-4275-8482-f77d32723c32';
            let results = [];
            
            // Test signal filtering
            const signalResult = await makeRequest(`${BACKEND_URL}/analyses/signal/bullish?user_id=${testUserId}&limit=5`);
            results.push(`Signal Filter (bullish): ${signalResult.success ? 'PASSED' : 'FAILED'} - Count: ${signalResult.success ? signalResult.data.count : 'N/A'}`);
            
            // Test sector filtering
            const sectorResult = await makeRequest(`${BACKEND_URL}/analyses/sector/energy?user_id=${testUserId}&limit=5`);
            results.push(`Sector Filter (energy): ${sectorResult.success ? 'PASSED' : 'FAILED'} - Count: ${sectorResult.success ? sectorResult.data.count : 'N/A'}`);
            
            // Test confidence filtering
            const confidenceResult = await makeRequest(`${BACKEND_URL}/analyses/confidence/70?user_id=${testUserId}&limit=5`);
            results.push(`Confidence Filter (70+): ${confidenceResult.success ? 'PASSED' : 'FAILED'} - Count: ${confidenceResult.success ? confidenceResult.data.count : 'N/A'}`);
            
            const allPassed = signalResult.success && sectorResult.success && confidenceResult.success;
            
            showResult('filteredAnalysesResult', 
                `‚úÖ Filtered Analyses APIs Test Results:\n` +
                results.join('\n') + '\n\n' +
                `Overall Status: ${allPassed ? 'PASSED' : 'FAILED'}`, 
                allPassed ? 'success' : 'error'
            );
            testResults.filteredAnalyses = allPassed;
            updateTestSummary();
        }

        async function testCompleteFlow() {
            showLoading('completeFlowResult');
            
            let flowResults = [];
            
            // Step 1: Health check
            const healthResult = await makeRequest(`${BACKEND_URL}/health`);
            flowResults.push(`1. Backend Health: ${healthResult.success ? 'PASSED' : 'FAILED'}`);
            
            // Step 2: Get user analyses
            const testUserId = '6036aee5-624c-4275-8482-f77d32723c32';
            const userResult = await makeRequest(`${BACKEND_URL}/analyses/user/${testUserId}?limit=1`);
            flowResults.push(`2. User Analyses: ${userResult.success ? 'PASSED' : 'FAILED'}`);
            
            // Step 3: Get analysis by ID (if we have analyses)
            let analysisByIdResult = 'SKIPPED';
            if (userResult.success && userResult.data.analyses && userResult.data.analyses.length > 0) {
                const analysisId = userResult.data.analyses[0].id;
                const analysisResult = await makeRequest(`${BACKEND_URL}/analyses/${analysisId}`);
                analysisByIdResult = analysisResult.success ? 'PASSED' : 'FAILED';
            }
            flowResults.push(`3. Analysis by ID: ${analysisByIdResult}`);
            
            // Step 4: Get summary
            const summaryResult = await makeRequest(`${BACKEND_URL}/analyses/summary/user/${testUserId}`);
            flowResults.push(`4. Analysis Summary: ${summaryResult.success ? 'PASSED' : 'FAILED'}`);
            
            const allPassed = healthResult.success && userResult.success && summaryResult.success;
            
            showResult('completeFlowResult', 
                `‚úÖ Complete Frontend-Backend Flow Test:\n` +
                flowResults.join('\n') + '\n\n' +
                `Overall Status: ${allPassed ? 'PASSED' : 'FAILED'}\n` +
                `Frontend can successfully communicate with backend database APIs!`, 
                allPassed ? 'success' : 'error'
            );
            testResults.completeFlow = allPassed;
            updateTestSummary();
        }

        function updateTestSummary() {
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const failedTests = totalTests - passedTests;
            
            let summary = `üìä Test Summary:\n`;
            summary += `Total Tests: ${totalTests}\n`;
            summary += `Passed: ${passedTests}\n`;
            summary += `Failed: ${failedTests}\n\n`;
            
            if (totalTests > 0) {
                summary += `Test Results:\n`;
                Object.entries(testResults).forEach(([test, result]) => {
                    summary += `‚Ä¢ ${test}: ${result ? '‚úÖ PASSED' : '‚ùå FAILED'}\n`;
                });
            }
            
            if (passedTests === totalTests && totalTests > 0) {
                summary += `\nüéâ ALL TESTS PASSED! Frontend database communication is working perfectly!`;
            } else if (totalTests > 0) {
                summary += `\n‚ö†Ô∏è Some tests failed. Please check the individual test results above.`;
            }
            
            showResult('testSummary', summary, passedTests === totalTests && totalTests > 0 ? 'success' : 'info');
        }

        // Auto-run health check on page load
        window.onload = function() {
            testBackendHealth();
        };
    </script>
</body>
</html> 