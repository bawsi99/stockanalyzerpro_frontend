<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consensus Card Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .signal-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .signal-indicator {
            font-weight: bold;
            color: #333;
        }
        .signal-value {
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        .signal-badges {
            display: flex;
            gap: 8px;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .badge-bullish {
            background: #d4edda;
            color: #155724;
        }
        .badge-bearish {
            background: #f8d7da;
            color: #721c24;
        }
        .badge-neutral {
            background: #fff3cd;
            color: #856404;
        }
        .badge-strong {
            background: #cce5ff;
            color: #004085;
        }
        .badge-moderate {
            background: #d1ecf1;
            color: #0c5460;
        }
        .badge-weak {
            background: #e2e3e5;
            color: #383d41;
        }
        .signal-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        .signal-weight {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        .weight-bar {
            width: 60px;
            background: #e9ecef;
            border-radius: 10px;
            height: 6px;
            overflow: hidden;
        }
        .weight-fill {
            background: #007bff;
            height: 100%;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Consensus Card Test</h1>
    <p>This page tests the consensus card to ensure it shows proper signal details with indicator levels, percentage differences, and moving average differences.</p>

    <div class="container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <div class="container">
        <h2>Sample Consensus Data</h2>
        <div id="consensus-data"></div>
    </div>

    <div class="container">
        <h2>Signal Details Preview</h2>
        <div id="signal-details"></div>
    </div>

    <script type="module">
        // Mock the extractSignalDetails function
        function extractSignalDetails(data) {
            const indicators = data.indicators || {};
            const signals = [];
            
            // RSI Analysis
            if (indicators.rsi) {
                const rsi = indicators.rsi.rsi_14;
                const rsiTrend = indicators.rsi.trend;
                const rsiStatus = indicators.rsi.status;
                
                let rsiSignal = 'neutral';
                let rsiStrength = 'weak';
                let rsiDescription = '';
                
                if (rsi > 70) {
                    rsiSignal = 'bearish';
                    rsiStrength = 'strong';
                    rsiDescription = `RSI at ${rsi.toFixed(1)} - Overbought conditions, potential reversal`;
                } else if (rsi > 60) {
                    rsiSignal = 'bearish';
                    rsiStrength = 'moderate';
                    rsiDescription = `RSI at ${rsi.toFixed(1)} - Near overbought, showing ${rsiTrend} momentum`;
                } else if (rsi < 30) {
                    rsiSignal = 'bullish';
                    rsiStrength = 'strong';
                    rsiDescription = `RSI at ${rsi.toFixed(1)} - Oversold conditions, potential bounce`;
                } else if (rsi < 40) {
                    rsiSignal = 'bullish';
                    rsiStrength = 'moderate';
                    rsiDescription = `RSI at ${rsi.toFixed(1)} - Near oversold, showing ${rsiTrend} momentum`;
                } else {
                    rsiSignal = 'neutral';
                    rsiStrength = 'weak';
                    rsiDescription = `RSI at ${rsi.toFixed(1)} - Neutral zone, ${rsiStatus} conditions`;
                }
                
                signals.push({
                    indicator: 'RSI',
                    signal: rsiSignal,
                    strength: rsiStrength,
                    description: rsiDescription,
                    value: rsi,
                    weight: 15
                });
            }
            
            // MACD Analysis
            if (indicators.macd) {
                const macdLine = indicators.macd.macd_line;
                const signalLine = indicators.macd.signal_line;
                const histogram = indicators.macd.histogram;
                
                let macdSignal = 'neutral';
                let macdStrength = 'weak';
                let macdDescription = '';
                
                if (macdLine > signalLine && histogram > 0) {
                    macdSignal = 'bullish';
                    macdStrength = histogram > 1 ? 'strong' : 'moderate';
                    macdDescription = `MACD line above signal line, histogram positive - Bullish momentum`;
                } else if (macdLine < signalLine && histogram < 0) {
                    macdSignal = 'bearish';
                    macdStrength = histogram < -1 ? 'strong' : 'moderate';
                    macdDescription = `MACD line below signal line, histogram negative - Bearish momentum`;
                } else {
                    macdSignal = 'neutral';
                    macdStrength = 'weak';
                    macdDescription = `MACD near signal line - Consolidation phase`;
                }
                
                signals.push({
                    indicator: 'MACD',
                    signal: macdSignal,
                    strength: macdStrength,
                    description: macdDescription,
                    value: macdLine,
                    weight: 12
                });
            }
            
            // Moving Averages Analysis
            if (indicators.moving_averages) {
                const priceToSma200 = indicators.moving_averages.price_to_sma_200;
                const sma20ToSma50 = indicators.moving_averages.sma_20_to_sma_50;
                const goldenCross = indicators.moving_averages.golden_cross;
                const deathCross = indicators.moving_averages.death_cross;
                
                // Price vs SMA 200
                if (priceToSma200 > 0.05) {
                    signals.push({
                        indicator: 'Price vs SMA 200',
                        signal: 'bullish',
                        strength: 'strong',
                        description: `Price ${(priceToSma200 * 100).toFixed(1)}% above SMA 200 - Strong uptrend`,
                        value: priceToSma200 * 100,
                        weight: 20
                    });
                } else if (priceToSma200 < -0.05) {
                    signals.push({
                        indicator: 'Price vs SMA 200',
                        signal: 'bearish',
                        strength: 'strong',
                        description: `Price ${Math.abs(priceToSma200 * 100).toFixed(1)}% below SMA 200 - Strong downtrend`,
                        value: priceToSma200 * 100,
                        weight: 20
                    });
                } else {
                    signals.push({
                        indicator: 'Price vs SMA 200',
                        signal: 'neutral',
                        strength: 'weak',
                        description: `Price near SMA 200 - Consolidation phase`,
                        value: priceToSma200 * 100,
                        weight: 20
                    });
                }
                
                // SMA 20 vs SMA 50
                if (sma20ToSma50 > 0.02) {
                    signals.push({
                        indicator: 'SMA 20 vs SMA 50',
                        signal: 'bullish',
                        strength: 'moderate',
                        description: `SMA 20 ${(sma20ToSma50 * 100).toFixed(1)}% above SMA 50 - Short-term uptrend`,
                        value: sma20ToSma50 * 100,
                        weight: 10
                    });
                } else if (sma20ToSma50 < -0.02) {
                    signals.push({
                        indicator: 'SMA 20 vs SMA 50',
                        signal: 'bearish',
                        strength: 'moderate',
                        description: `SMA 20 ${Math.abs(sma20ToSma50 * 100).toFixed(1)}% below SMA 50 - Short-term downtrend`,
                        value: sma20ToSma50 * 100,
                        weight: 10
                    });
                }
                
                // Golden/Death Cross
                if (goldenCross) {
                    signals.push({
                        indicator: 'Golden Cross',
                        signal: 'bullish',
                        strength: 'strong',
                        description: 'SMA 20 crossed above SMA 50 - Bullish signal',
                        value: 1,
                        weight: 15
                    });
                } else if (deathCross) {
                    signals.push({
                        indicator: 'Death Cross',
                        signal: 'bearish',
                        strength: 'strong',
                        description: 'SMA 20 crossed below SMA 50 - Bearish signal',
                        value: -1,
                        weight: 15
                    });
                }
            }
            
            // Bollinger Bands Analysis
            if (indicators.bollinger_bands) {
                const percentB = indicators.bollinger_bands.percent_b;
                
                let bbSignal = 'neutral';
                let bbStrength = 'weak';
                let bbDescription = '';
                
                if (percentB > 0.8) {
                    bbSignal = 'bearish';
                    bbStrength = 'moderate';
                    bbDescription = `Price near upper Bollinger Band - Potential resistance`;
                } else if (percentB < 0.2) {
                    bbSignal = 'bullish';
                    bbStrength = 'moderate';
                    bbDescription = `Price near lower Bollinger Band - Potential support`;
                } else if (percentB > 0.6) {
                    bbSignal = 'bearish';
                    bbStrength = 'weak';
                    bbDescription = `Price in upper Bollinger Band range`;
                } else if (percentB < 0.4) {
                    bbSignal = 'bullish';
                    bbStrength = 'weak';
                    bbDescription = `Price in lower Bollinger Band range`;
                } else {
                    bbSignal = 'neutral';
                    bbStrength = 'weak';
                    bbDescription = `Price in middle Bollinger Band range - Neutral`;
                }
                
                signals.push({
                    indicator: 'Bollinger Bands',
                    signal: bbSignal,
                    strength: bbStrength,
                    description: bbDescription,
                    value: percentB,
                    weight: 8
                });
            }
            
            // Volume Analysis
            if (indicators.volume) {
                const volumeRatio = indicators.volume.volume_ratio;
                const obvTrend = indicators.volume.obv_trend;
                
                let volumeSignal = 'neutral';
                let volumeStrength = 'weak';
                let volumeDescription = '';
                
                if (volumeRatio > 1.5) {
                    volumeSignal = 'bullish';
                    volumeStrength = 'strong';
                    volumeDescription = `Volume ${(volumeRatio * 100).toFixed(0)}% above average - Strong buying pressure`;
                } else if (volumeRatio > 1.2) {
                    volumeSignal = 'bullish';
                    volumeStrength = 'moderate';
                    volumeDescription = `Volume ${(volumeRatio * 100).toFixed(0)}% above average - Good volume support`;
                } else if (volumeRatio < 0.8) {
                    volumeSignal = 'bearish';
                    volumeStrength = 'moderate';
                    volumeDescription = `Volume ${((1 - volumeRatio) * 100).toFixed(0)}% below average - Weak volume`;
                } else {
                    volumeSignal = 'neutral';
                    volumeStrength = 'weak';
                    volumeDescription = `Volume at normal levels - ${obvTrend} trend`;
                }
                
                signals.push({
                    indicator: 'Volume',
                    signal: volumeSignal,
                    strength: volumeStrength,
                    description: volumeDescription,
                    value: volumeRatio,
                    weight: 10
                });
            }
            
            // ADX Analysis
            if (indicators.adx) {
                const adx = indicators.adx.adx;
                const plusDi = indicators.adx.plus_di;
                const minusDi = indicators.adx.minus_di;
                const trendDirection = indicators.adx.trend_direction;
                
                let adxSignal = 'neutral';
                let adxStrength = 'weak';
                let adxDescription = '';
                
                if (adx > 25) {
                    if (plusDi > minusDi) {
                        adxSignal = 'bullish';
                        adxStrength = 'strong';
                        adxDescription = `ADX at ${adx.toFixed(1)} - Strong bullish trend`;
                    } else {
                        adxSignal = 'bearish';
                        adxStrength = 'strong';
                        adxDescription = `ADX at ${adx.toFixed(1)} - Strong bearish trend`;
                    }
                } else {
                    adxSignal = 'neutral';
                    adxStrength = 'weak';
                    adxDescription = `ADX at ${adx.toFixed(1)} - Weak trend, ${trendDirection} bias`;
                }
                
                signals.push({
                    indicator: 'ADX',
                    signal: adxSignal,
                    strength: adxStrength,
                    description: adxDescription,
                    value: adx,
                    weight: 10
                });
            }
            
            return signals;
        }

        // Test data
        const testData = {
            indicators: {
                rsi: {
                    rsi_14: 65.0,
                    trend: 'up',
                    status: 'near_overbought'
                },
                macd: {
                    macd_line: 5.0,
                    signal_line: 3.0,
                    histogram: 2.0
                },
                moving_averages: {
                    sma_20: 1510.0,
                    sma_50: 1490.0,
                    sma_200: 1450.0,
                    price_to_sma_200: 0.034,
                    sma_20_to_sma_50: 0.013,
                    golden_cross: true,
                    death_cross: false
                },
                bollinger_bands: {
                    upper_band: 1550.0,
                    middle_band: 1500.0,
                    lower_band: 1450.0,
                    percent_b: 0.5,
                    bandwidth: 0.067
                },
                volume: {
                    volume_ratio: 1.2,
                    obv: 1000000,
                    obv_trend: 'up'
                },
                adx: {
                    adx: 25.0,
                    plus_di: 30.0,
                    minus_di: 20.0,
                    trend_direction: 'bullish'
                }
            }
        };

        // Run tests
        function runTests() {
            const results = [];
            
            try {
                // Test 1: Extract signal details
                const signalDetails = extractSignalDetails(testData);
                results.push({ test: 'Signal Details Extraction', status: 'success', message: `Extracted ${signalDetails.length} signals` });

                // Test 2: Check signal types
                const bullishSignals = signalDetails.filter(s => s.signal === 'bullish');
                const bearishSignals = signalDetails.filter(s => s.signal === 'bearish');
                const neutralSignals = signalDetails.filter(s => s.signal === 'neutral');
                
                results.push({ 
                    test: 'Signal Distribution', 
                    status: 'success', 
                    message: `Bullish: ${bullishSignals.length}, Bearish: ${bearishSignals.length}, Neutral: ${neutralSignals.length}` 
                });

                // Test 3: Check specific indicators
                const hasRSI = signalDetails.some(s => s.indicator === 'RSI');
                const hasMACD = signalDetails.some(s => s.indicator === 'MACD');
                const hasMovingAverages = signalDetails.some(s => s.indicator.includes('SMA'));
                const hasBollingerBands = signalDetails.some(s => s.indicator === 'Bollinger Bands');
                const hasVolume = signalDetails.some(s => s.indicator === 'Volume');
                const hasADX = signalDetails.some(s => s.indicator === 'ADX');
                
                const indicatorsFound = [hasRSI, hasMACD, hasMovingAverages, hasBollingerBands, hasVolume, hasADX].filter(Boolean).length;
                results.push({ 
                    test: 'Indicator Coverage', 
                    status: 'success', 
                    message: `Found ${indicatorsFound}/6 major indicators` 
                });

                // Test 4: Check signal details structure
                const hasValidStructure = signalDetails.every(s => 
                    s.indicator && s.signal && s.strength && s.description && s.value !== undefined && s.weight
                );
                
                if (hasValidStructure) {
                    results.push({ test: 'Signal Structure', status: 'success', message: 'All signals have valid structure' });
                } else {
                    results.push({ test: 'Signal Structure', status: 'error', message: 'Some signals missing required fields' });
                }

                // Display results
                displayResults(results);
                displayConsensusData(signalDetails);
                displaySignalDetails(signalDetails);

            } catch (error) {
                results.push({ test: 'General', status: 'error', message: 'Test failed with error: ' + error.message });
                displayResults(results);
            }
        }

        function displayResults(results) {
            const container = document.getElementById('test-results');
            let html = '';

            results.forEach(result => {
                const statusClass = result.status === 'success' ? 'success' : 'error';
                html += `
                    <div class="${statusClass}">
                        <strong>${result.test}:</strong> ${result.message}
                    </div>
                `;
            });

            const passed = results.filter(r => r.status === 'success').length;
            const total = results.length;
            
            html = `
                <div class="info">
                    ðŸ“Š Test Results: ${passed}/${total} tests passed
                </div>
                ${html}
            `;

            container.innerHTML = html;
        }

        function displayConsensusData(signalDetails) {
            const container = document.getElementById('consensus-data');
            
            // Calculate percentages
            const bullishSignals = signalDetails.filter(s => s.signal === 'bullish');
            const bearishSignals = signalDetails.filter(s => s.signal === 'bearish');
            const neutralSignals = signalDetails.filter(s => s.signal === 'neutral');
            
            const totalWeight = signalDetails.reduce((sum, s) => sum + (s.weight || 0), 0);
            const bullishWeight = bullishSignals.reduce((sum, s) => sum + (s.weight || 0), 0);
            const bearishWeight = bearishSignals.reduce((sum, s) => sum + (s.weight || 0), 0);
            const neutralWeight = neutralSignals.reduce((sum, s) => sum + (s.weight || 0), 0);
            
            const bullishPercentage = totalWeight > 0 ? Math.round((bullishWeight / totalWeight) * 100) : 0;
            const bearishPercentage = totalWeight > 0 ? Math.round((bearishWeight / totalWeight) * 100) : 0;
            const neutralPercentage = Math.max(0, 100 - bullishPercentage - bearishPercentage);
            
            container.innerHTML = `
                <h3>Consensus Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 8px; border: 1px solid #c3e6cb;">
                        <div style="color: #155724; font-weight: bold; font-size: 24px;">${bullishPercentage}%</div>
                        <div style="color: #155724; font-weight: 500;">Bullish</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f8d7da, #f5c6cb); border-radius: 8px; border: 1px solid #f5c6cb;">
                        <div style="color: #721c24; font-weight: bold; font-size: 24px;">${bearishPercentage}%</div>
                        <div style="color: #721c24; font-weight: 500;">Bearish</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 8px; border: 1px solid #ffeaa7;">
                        <div style="color: #856404; font-weight: bold; font-size: 24px;">${neutralPercentage}%</div>
                        <div style="color: #856404; font-weight: 500;">Neutral</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <strong>Total Signals:</strong> ${signalDetails.length}<br>
                    <strong>Total Weight:</strong> ${totalWeight}<br>
                    <strong>Bullish Weight:</strong> ${bullishWeight}<br>
                    <strong>Bearish Weight:</strong> ${bearishWeight}<br>
                    <strong>Neutral Weight:</strong> ${neutralWeight}
                </div>
            `;
        }

        function displaySignalDetails(signalDetails) {
            const container = document.getElementById('signal-details');
            
            if (signalDetails.length === 0) {
                container.innerHTML = '<p>No signal details available</p>';
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">';
            
            signalDetails.forEach((signal, index) => {
                const signalClass = signal.signal === 'bullish' ? 'badge-bullish' : 
                                  signal.signal === 'bearish' ? 'badge-bearish' : 'badge-neutral';
                const strengthClass = signal.strength === 'strong' ? 'badge-strong' : 
                                    signal.strength === 'moderate' ? 'badge-moderate' : 'badge-weak';
                
                html += `
                    <div class="signal-card">
                        <div class="signal-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="signal-indicator">${signal.indicator}</span>
                                ${signal.value !== undefined ? `<span class="signal-value">${typeof signal.value === 'number' ? signal.value.toFixed(2) : signal.value}</span>` : ''}
                            </div>
                            <div class="signal-badges">
                                <span class="badge ${signalClass}">${signal.signal.toUpperCase()}</span>
                                <span class="badge ${strengthClass}">${signal.strength.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="signal-description">${signal.description}</div>
                        ${signal.weight ? `
                            <div class="signal-weight">
                                <span>Weight:</span>
                                <div class="weight-bar">
                                    <div class="weight-fill" style="width: ${(signal.weight / 20) * 100}%"></div>
                                </div>
                                <span>${signal.weight}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html> 