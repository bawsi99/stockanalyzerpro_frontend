<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consensus Card Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .signal-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        .badge-bullish {
            background: #d4edda;
            color: #155724;
        }
        .badge-bearish {
            background: #f8d7da;
            color: #721c24;
        }
        .badge-neutral {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Consensus Card Fix Test</h1>
    <p>This page tests the consensus card fix to ensure it properly transforms data and shows signal details.</p>

    <div class="container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <div class="container">
        <h2>Sample Backend Data</h2>
        <div id="backend-data"></div>
    </div>

    <div class="container">
        <h2>Transformed Data</h2>
        <div id="transformed-data"></div>
    </div>

    <div class="container">
        <h2>Consensus Card Preview</h2>
        <div id="consensus-preview"></div>
    </div>

    <script type="module">
        // Mock the transformDatabaseRecord function
        function transformDatabaseRecord(record) {
            const analysisData = record.analysis_data;
            
            // Mock the extractSignalDetails function
            function extractSignalDetails(data) {
                const indicators = data.indicators || {};
                const signals = [];
                
                // RSI Analysis
                if (indicators.rsi) {
                    const rsi = indicators.rsi.rsi_14;
                    const rsiTrend = indicators.rsi.trend;
                    const rsiStatus = indicators.rsi.status;
                    
                    let rsiSignal = 'neutral';
                    let rsiStrength = 'weak';
                    let rsiDescription = '';
                    
                    if (rsi > 70) {
                        rsiSignal = 'bearish';
                        rsiStrength = 'strong';
                        rsiDescription = `RSI at ${rsi.toFixed(1)} - Overbought conditions, potential reversal`;
                    } else if (rsi > 60) {
                        rsiSignal = 'bearish';
                        rsiStrength = 'moderate';
                        rsiDescription = `RSI at ${rsi.toFixed(1)} - Near overbought, showing ${rsiTrend} momentum`;
                    } else if (rsi < 30) {
                        rsiSignal = 'bullish';
                        rsiStrength = 'strong';
                        rsiDescription = `RSI at ${rsi.toFixed(1)} - Oversold conditions, potential bounce`;
                    } else if (rsi < 40) {
                        rsiSignal = 'bullish';
                        rsiStrength = 'moderate';
                        rsiDescription = `RSI at ${rsi.toFixed(1)} - Near oversold, showing ${rsiTrend} momentum`;
                    } else {
                        rsiSignal = 'neutral';
                        rsiStrength = 'weak';
                        rsiDescription = `RSI at ${rsi.toFixed(1)} - Neutral zone, ${rsiStatus} conditions`;
                    }
                    
                    signals.push({
                        indicator: 'RSI',
                        signal: rsiSignal,
                        strength: rsiStrength,
                        description: rsiDescription,
                        value: rsi,
                        weight: 15
                    });
                }
                
                // MACD Analysis
                if (indicators.macd) {
                    const macdLine = indicators.macd.macd_line;
                    const signalLine = indicators.macd.signal_line;
                    const histogram = indicators.macd.histogram;
                    
                    let macdSignal = 'neutral';
                    let macdStrength = 'weak';
                    let macdDescription = '';
                    
                    if (macdLine > signalLine && histogram > 0) {
                        macdSignal = 'bullish';
                        macdStrength = histogram > 1 ? 'strong' : 'moderate';
                        macdDescription = `MACD line above signal line, histogram positive - Bullish momentum`;
                    } else if (macdLine < signalLine && histogram < 0) {
                        macdSignal = 'bearish';
                        macdStrength = histogram < -1 ? 'strong' : 'moderate';
                        macdDescription = `MACD line below signal line, histogram negative - Bearish momentum`;
                    } else {
                        macdSignal = 'neutral';
                        macdStrength = 'weak';
                        macdDescription = `MACD near signal line - Consolidation phase`;
                    }
                    
                    signals.push({
                        indicator: 'MACD',
                        signal: macdSignal,
                        strength: macdStrength,
                        description: macdDescription,
                        value: macdLine,
                        weight: 12
                    });
                }
                
                // Moving Averages Analysis
                if (indicators.moving_averages) {
                    const priceToSma200 = indicators.moving_averages.price_to_sma_200;
                    const sma20ToSma50 = indicators.moving_averages.sma_20_to_sma_50;
                    const goldenCross = indicators.moving_averages.golden_cross;
                    const deathCross = indicators.moving_averages.death_cross;
                    
                    // Price vs SMA 200
                    if (priceToSma200 > 0.05) {
                        signals.push({
                            indicator: 'Price vs SMA 200',
                            signal: 'bullish',
                            strength: 'strong',
                            description: `Price ${(priceToSma200 * 100).toFixed(1)}% above SMA 200 - Strong uptrend`,
                            value: priceToSma200 * 100,
                            weight: 20
                        });
                    } else if (priceToSma200 < -0.05) {
                        signals.push({
                            indicator: 'Price vs SMA 200',
                            signal: 'bearish',
                            strength: 'strong',
                            description: `Price ${Math.abs(priceToSma200 * 100).toFixed(1)}% below SMA 200 - Strong downtrend`,
                            value: priceToSma200 * 100,
                            weight: 20
                        });
                    } else {
                        signals.push({
                            indicator: 'Price vs SMA 200',
                            signal: 'neutral',
                            strength: 'weak',
                            description: `Price near SMA 200 - Consolidation phase`,
                            value: priceToSma200 * 100,
                            weight: 20
                        });
                    }
                    
                    // SMA 20 vs SMA 50
                    if (sma20ToSma50 > 0.02) {
                        signals.push({
                            indicator: 'SMA 20 vs SMA 50',
                            signal: 'bullish',
                            strength: 'moderate',
                            description: `SMA 20 ${(sma20ToSma50 * 100).toFixed(1)}% above SMA 50 - Short-term uptrend`,
                            value: sma20ToSma50 * 100,
                            weight: 10
                        });
                    } else if (sma20ToSma50 < -0.02) {
                        signals.push({
                            indicator: 'SMA 20 vs SMA 50',
                            signal: 'bearish',
                            strength: 'moderate',
                            description: `SMA 20 ${Math.abs(sma20ToSma50 * 100).toFixed(1)}% below SMA 50 - Short-term downtrend`,
                            value: sma20ToSma50 * 100,
                            weight: 10
                        });
                    }
                    
                    // Golden/Death Cross
                    if (goldenCross) {
                        signals.push({
                            indicator: 'Golden Cross',
                            signal: 'bullish',
                            strength: 'strong',
                            description: 'SMA 20 crossed above SMA 50 - Bullish signal',
                            value: 1,
                            weight: 15
                        });
                    } else if (deathCross) {
                        signals.push({
                            indicator: 'Death Cross',
                            signal: 'bearish',
                            strength: 'strong',
                            description: 'SMA 20 crossed below SMA 50 - Bearish signal',
                            value: -1,
                            weight: 15
                        });
                    }
                }
                
                return signals;
            }
            
            // Mock the extractConsensus function
            function extractConsensus(data) {
                const summary = data.summary || {};
                const aiAnalysis = data.ai_analysis || {};
                const signalDetails = extractSignalDetails(data);
                
                // Calculate percentages from signal details
                const bullishSignals = signalDetails.filter(s => s.signal === 'bullish');
                const bearishSignals = signalDetails.filter(s => s.signal === 'bearish');
                const neutralSignals = signalDetails.filter(s => s.signal === 'neutral');
                
                const totalWeight = signalDetails.reduce((sum, s) => sum + (s.weight || 0), 0);
                const bullishWeight = bullishSignals.reduce((sum, s) => sum + (s.weight || 0), 0);
                const bearishWeight = bearishSignals.reduce((sum, s) => sum + (s.weight || 0), 0);
                const neutralWeight = neutralSignals.reduce((sum, s) => sum + (s.weight || 0), 0);
                
                const bullishPercentage = totalWeight > 0 ? Math.round((bullishWeight / totalWeight) * 100) : 0;
                const bearishPercentage = totalWeight > 0 ? Math.round((bearishWeight / totalWeight) * 100) : 0;
                const neutralPercentage = Math.max(0, 100 - bullishPercentage - bearishPercentage);
                
                return {
                    overall_signal: summary.overall_signal || aiAnalysis.trend || 'Neutral',
                    signal_strength: summary.analysis_quality || 'Medium',
                    bullish_percentage: bullishPercentage,
                    bearish_percentage: bearishPercentage,
                    neutral_percentage: neutralPercentage,
                    bullish_score: 0,
                    bearish_score: 0,
                    neutral_score: 0,
                    total_weight: 100,
                    confidence: summary.confidence || aiAnalysis.confidence_pct || 0,
                    signal_details: signalDetails,
                    data_quality_flags: [],
                    warnings: [],
                    bullish_count: bullishSignals.length,
                    bearish_count: bearishSignals.length,
                    neutral_count: neutralSignals.length
                };
            }
            
            return {
                consensus: extractConsensus(analysisData),
                indicators: analysisData.indicators || {},
                charts: {},
                ai_analysis: analysisData.ai_analysis || {},
                indicator_summary_md: analysisData.indicator_summary_md || '',
                chart_insights: analysisData.chart_insights || '',
                sector_benchmarking: analysisData.sector_benchmarking,
                summary: analysisData.summary || {},
                support_levels: analysisData.support_levels || [],
                resistance_levels: analysisData.resistance_levels || [],
                triangle_patterns: analysisData.triangle_patterns || [],
                flag_patterns: analysisData.flag_patterns || [],
                volume_anomalies_detailed: analysisData.volume_anomalies_detailed || [],
                overlays: analysisData.overlays || {},
                trading_guidance: analysisData.trading_guidance,
                multi_timeframe_analysis: analysisData.multi_timeframe_analysis
            };
        }

        // Sample backend data (what would be stored in localStorage)
        const sampleBackendData = {
            stock_symbol: "RELIANCE",
            indicators: {
                rsi: {
                    rsi_14: 65.0,
                    trend: 'up',
                    status: 'near_overbought'
                },
                macd: {
                    macd_line: 5.0,
                    signal_line: 3.0,
                    histogram: 2.0
                },
                moving_averages: {
                    sma_20: 1510.0,
                    sma_50: 1490.0,
                    sma_200: 1450.0,
                    price_to_sma_200: 0.034,
                    sma_20_to_sma_50: 0.013,
                    golden_cross: true,
                    death_cross: false
                },
                bollinger_bands: {
                    upper_band: 1550.0,
                    middle_band: 1500.0,
                    lower_band: 1450.0,
                    percent_b: 0.5,
                    bandwidth: 0.067
                },
                volume: {
                    volume_ratio: 1.2,
                    obv: 1000000,
                    obv_trend: 'up'
                },
                adx: {
                    adx: 25.0,
                    plus_di: 30.0,
                    minus_di: 20.0,
                    trend_direction: 'bullish'
                }
            },
            summary: {
                overall_signal: 'Bullish',
                analysis_quality: 'Strong',
                confidence: 75
            },
            ai_analysis: {
                trend: 'Bullish',
                confidence_pct: 75
            }
        };

        // Run tests
        function runTests() {
            const results = [];
            
            try {
                // Test 1: Transform data
                const transformedData = transformDatabaseRecord({
                    id: '1',
                    user_id: '1',
                    stock_symbol: 'RELIANCE',
                    analysis_data: sampleBackendData,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                });
                
                results.push({ test: 'Data Transformation', status: 'success', message: 'Data transformed successfully' });

                // Test 2: Check consensus data
                const consensus = transformedData.consensus;
                if (consensus && consensus.signal_details && consensus.signal_details.length > 0) {
                    results.push({ test: 'Consensus Data', status: 'success', message: `Consensus has ${consensus.signal_details.length} signal details` });
                } else {
                    results.push({ test: 'Consensus Data', status: 'error', message: 'No consensus data or signal details found' });
                }

                // Test 3: Check signal details
                const signalDetails = consensus.signal_details;
                if (signalDetails && signalDetails.length > 0) {
                    const bullishCount = signalDetails.filter(s => s.signal === 'bullish').length;
                    const bearishCount = signalDetails.filter(s => s.signal === 'bearish').length;
                    const neutralCount = signalDetails.filter(s => s.signal === 'neutral').length;
                    
                    results.push({ 
                        test: 'Signal Details', 
                        status: 'success', 
                        message: `Found ${signalDetails.length} signals: ${bullishCount} bullish, ${bearishCount} bearish, ${neutralCount} neutral` 
                    });
                } else {
                    results.push({ test: 'Signal Details', status: 'error', message: 'No signal details found' });
                }

                // Test 4: Check percentages
                if (consensus.bullish_percentage > 0 || consensus.bearish_percentage > 0 || consensus.neutral_percentage > 0) {
                    results.push({ 
                        test: 'Percentage Calculation', 
                        status: 'success', 
                        message: `Bullish: ${consensus.bullish_percentage}%, Bearish: ${consensus.bearish_percentage}%, Neutral: ${consensus.neutral_percentage}%` 
                    });
                } else {
                    results.push({ test: 'Percentage Calculation', status: 'error', message: 'All percentages are 0' });
                }

                // Display results
                displayResults(results);
                displayBackendData(sampleBackendData);
                displayTransformedData(transformedData);
                displayConsensusPreview(consensus);

            } catch (error) {
                results.push({ test: 'General', status: 'error', message: 'Test failed with error: ' + error.message });
                displayResults(results);
            }
        }

        function displayResults(results) {
            const container = document.getElementById('test-results');
            let html = '';

            results.forEach(result => {
                const statusClass = result.status === 'success' ? 'success' : 'error';
                html += `
                    <div class="${statusClass}">
                        <strong>${result.test}:</strong> ${result.message}
                    </div>
                `;
            });

            const passed = results.filter(r => r.status === 'success').length;
            const total = results.length;
            
            html = `
                <div class="info">
                    ðŸ“Š Test Results: ${passed}/${total} tests passed
                </div>
                ${html}
            `;

            container.innerHTML = html;
        }

        function displayBackendData(data) {
            const container = document.getElementById('backend-data');
            container.innerHTML = `
                <h3>Raw Backend Data (from localStorage)</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        function displayTransformedData(data) {
            const container = document.getElementById('transformed-data');
            container.innerHTML = `
                <h3>Transformed Data (after transformDatabaseRecord)</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        function displayConsensusPreview(consensus) {
            const container = document.getElementById('consensus-preview');
            
            if (!consensus || !consensus.signal_details || consensus.signal_details.length === 0) {
                container.innerHTML = '<p class="error">No consensus data available</p>';
                return;
            }
            
            let html = `
                <div class="card">
                    <h3>Analysis Consensus</h3>
                    <div style="text-align: center; margin: 20px 0;">
                        <span class="badge badge-${consensus.overall_signal.toLowerCase()}">
                            ${consensus.overall_signal.toUpperCase()} (${consensus.signal_strength})
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 8px; border: 1px solid #c3e6cb;">
                            <div style="color: #155724; font-weight: bold; font-size: 24px;">${consensus.bullish_percentage}%</div>
                            <div style="color: #155724; font-weight: 500;">Bullish</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f8d7da, #f5c6cb); border-radius: 8px; border: 1px solid #f5c6cb;">
                            <div style="color: #721c24; font-weight: bold; font-size: 24px;">${consensus.bearish_percentage}%</div>
                            <div style="color: #721c24; font-weight: 500;">Bearish</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 8px; border: 1px solid #ffeaa7;">
                            <div style="color: #856404; font-weight: bold; font-size: 24px;">${consensus.neutral_percentage}%</div>
                            <div style="color: #856404; font-weight: 500;">Neutral</div>
                        </div>
                    </div>
                    
                    <h4>Technical Indicators (${consensus.signal_details.length} signals)</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            consensus.signal_details.forEach((signal, index) => {
                const signalClass = signal.signal === 'bullish' ? 'badge-bullish' : 
                                  signal.signal === 'bearish' ? 'badge-bearish' : 'badge-neutral';
                
                html += `
                    <div class="signal-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: bold; color: #333;">${signal.indicator}</span>
                                ${signal.value !== undefined ? `<span style="background: #f8f9fa; padding: 2px 8px; border-radius: 4px; font-size: 12px; color: #666;">${typeof signal.value === 'number' ? signal.value.toFixed(2) : signal.value}</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <span class="badge ${signalClass}">${signal.signal.toUpperCase()}</span>
                                <span style="background: #e2e3e5; color: #383d41; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">${signal.strength.toUpperCase()}</span>
                            </div>
                        </div>
                        <div style="color: #666; font-size: 14px; line-height: 1.4;">${signal.description}</div>
                        ${signal.weight ? `
                            <div style="margin-top: 10px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #666;">
                                <span>Weight:</span>
                                <div style="width: 60px; background: #e9ecef; border-radius: 10px; height: 6px; overflow: hidden;">
                                    <div style="background: #007bff; height: 100%; border-radius: 10px; width: ${(signal.weight / 20) * 100}%;"></div>
                                </div>
                                <span>${signal.weight}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html> 